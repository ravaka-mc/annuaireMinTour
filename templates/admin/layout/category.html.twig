{% extends 'base-admin.html.twig' %}

{% block title %}Annuaire{% endblock %}

{% block body %}
    <main id="content" class="flex custom-table-mobile">
        <section id="contenu" class="candidat">
            {% include "admin/block/logout.html.twig" %}
            <div class="d-flex sb header">
                <div class="title">Catégories</div>
                <a data-fancybox data-src="#newcat" href="javascript:;" class="btn">Nouvelle catégorie</a>
            </div>
            <table id="table-list" class="custom-table-ville">
                <thead>
                    <tr>
                        <th></th>
                        <th><span>Nom</span></th>
                        <th><span>Date d'ajout</span></th>
                        <th><span>Action</span></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                        <tr>
                            <td></td>
                            <td>{{ category.nom }}</td>
                            <td>{{ category.getCreatedAt()|date('d-m-Y') }}</td>
                            <td>
                                <div class="action">
                                    <a data-fancybox data-src="#edit_{{ category.id }}" href="javascript:;" class="edit"></a>
                                    <a data-fancybox data-src="#supprimer_{{ category.id }}" class="delete"></a>
                                </div>
                            </td>
                            <td></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% include "admin/block/copyright.html.twig" %}
        </section>
    </main>
    <!-- Modal -->
    <div style="display: none; min-width: 400px; max-width: 500px;" id="newcat" class="popup-style">
        <div class="sub-title">Ajout nouvelle <strong>catégorie</strong></div>
        <form enctype="multipart/form-data" id="form-category" class="form-wrap" method="post" name="{{ form.vars.full_name }}" action="{{ path("app_admin_category_add") }}">
             <ul class="form-error"></ul>
            <div class="form-control">
                <label for="nom">Nom</label>
                {{ form_widget(form.nom) }}
            </div>
            <div class="form-control">
                <label for="nom">Icom</label>
                {{ form_widget(form.iconFile) }}
            </div>
            {{ form_widget(form._token) }}
            <div class="pbtn full"><button id="btn-add" type="button" class="btn red">Ajouter catégorie</button></div>
        </form>
    </div>
    {% for category in categories %}
        <div style="display: none; min-width: 400px; max-width: 500px;" id="edit_{{ category.id }}" class="popup-style">
            <div class="sub-title">Ajout nouvelle <strong>catégorie</strong></div>
            <form enctype="multipart/form-data" class="form-wrap" method="post" action="{{ path("app_admin_category_edit", {id:category.id}) }}">
                <div class="form-control">
                    <label for="nom">Nom</label>
                    <input type="text" name="nom" value="{{ category.nom }}">
                </div>
                <div class="form-control">
                    <label for="nom"> <img src="{{ asset('uploads/categories/' ~ category.icon) }}"></label>
                    <input type="file" name="icon" value="{{ category.icon }}">
                </div>
                <div class="pbtn full"><button type="submit" class="btn red">Enregistré</button></div>
            </form>
        </div>
        <div id="supprimer_{{ category.id }}" class="pop_suppr" style="display:none; max-width:500px;">
            <div class="innerpad">
                <div class="sub-title">Vouler vraiment supprimer ?</div>
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Facilis tempora repellat soluta perferendis earum animi porro</p>
            </div>
            <div class="pop_btns">
                <a href="{{ path('app_admin_category_delete',{id:category.id}) }}" class="btn-pop confirm">Supprimer</a>
                <span data-fancybox-close class="btn-pop">Annuler</span>
            </div>
        </div>
    {% endfor %}
    <div style="display:none" id="dialog-message" title="Information">
        <p>
            La catégorie a été bien enregistrée avec succès
        </p>
    </div>
{% endblock %}
{% block javascripts %}
    <script src="{{ asset('admin/js/jquery.fancybox.min.js') }}"></script>
    <script src="{{ asset('admin/js/datatable.min.js') }}"></script>
    <script src="{{ asset('admin/js/datatable-reponsive.min.js') }}"></script>
    <script src="{{ asset('admin/js/customize.js') }}"></script>
    <script>
        $(document).ready(function () {
            $.fn.dataTable.Responsive.breakpoints = [
                { name: 'desktop', width: Infinity },
                { name: 'tablet', width: 1024 },
                { name: 'fablet', width: 768 },
                { name: 'phone', width: 480 }
            ];
            $('#table-list').DataTable({
                paging: true,
                "searching": true,
                "info": false,
                "bLengthChange": false,
                "bInfo": false,
                responsive: true,
                "ordering": false,
                "language": {
                    "lengthMenu": "Afficher _MENU_",
                    "zeroRecords": "Rien n'a été trouvé, désolé",
                    "info": "Nombre de lignes <span class='current'>_PAGE_</span> sur <span>_PAGES_</span>",
                    "infoEmpty": "Non disponible",
                    "infoFiltered": "(filtré sur _MAX_ enregistrements)",
                    "search": "",
                    "searchPlaceholder": "Recherche",
                    "sPaginationType": "3",
                    "paginate": {
                        "previous": "<",
                        "next": ">"
                    }
                }
            });

            $(".close").click(function () {
                $(this).parent().parent().remove();
            });

            $("#btn-add").click(function(e){
                e.preventDefault();
                $.ajax({
                    url: $('#form-category').attr('action'),
                    processData: false,
                    contentType: false,
                    method: 'POST',
                    data: new FormData(document.getElementById('form-category')),
                    success: function(resp){
                        if(resp.code_status == 503){
                            error = resp.msg_error;
                            html = "";
                           for (let i = 0; i < error.length; i++){
                                html += "<li>" + error[i] + "</li>";
                            }
                            $(".form-error").html(html);
                        } else {
                            document.getElementById("form-category").reset();
                            $('.carousel__button').trigger('click');
                            $( "#dialog-message" ).dialog({
                                modal: true,
                                width: 500,
                                close: function(){
                                    window.location = '{{ path("app_admin_category") }}';
                                }
                            });
                        }
                    },
                    error: function(e){
                        console.log(e);
                    }
                });
            })
        });
    </script>
{% endblock %}
